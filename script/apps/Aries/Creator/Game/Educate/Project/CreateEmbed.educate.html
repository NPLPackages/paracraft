<html>
    <body>
        <pe:mcml>
            <script type='text/npl' refresh='false'>
                <![CDATA[
                    -- lib
                    local KpUserTag = NPL.load('(gl)script/apps/Aries/Creator/Game/mcml/keepwork/KpUserTag.lua')
                    local UniString = commonlib.gettable('System.Core.UniString')

                    -- bottles
                    local Create = NPL.load('(gl)Mod/WorldShare/cellar/Create/Create.lua')
                    local CreateWorld = NPL.load('(gl)Mod/WorldShare/cellar/CreateWorld/CreateWorld.lua')
                    local MainLogin = NPL.load('(gl)Mod/WorldShare/cellar/MainLogin/MainLogin.lua')
                    local CommonLoadWorld = NPL.load('(gl)Mod/WorldShare/cellar/Common/LoadWorld/CommonLoadWorld.lua')
                    local VersionChange = NPL.load('(gl)Mod/WorldShare/cellar/VersionChange/VersionChange.lua')
                    local DeleteWorld = NPL.load('(gl)Mod/WorldShare/cellar/DeleteWorld/DeleteWorld.lua')
                    local ShareWorld = NPL.load('(gl)script/apps/Aries/Creator/Game/Educate/Other/ShareWorld.lua')

                    -- service
                    local KeepworkServiceSession = NPL.load('(gl)Mod/WorldShare/service/KeepworkService/KeepworkServiceSession.lua')
                    local KeepworkServiceProject = NPL.load('(gl)Mod/WorldShare/service/KeepworkService/KeepworkServiceProject.lua')

                    -- config
                    local Config = NPL.load('(gl)Mod/WorldShare/config/Config.lua')

                    local page = document:GetPageCtrl()

                    UIAnimManager.LoadUIAnimationFile('script/UIAnimation/CommonProgress.lua.table')

                    local do_modify = false
                    local current_item_index = 1
                    local temp_modify_worldname = ''
                    local current_menu_index = 1

                    function is_modifying()
                        return do_modify
                    end

                    function covert_status()
                        local currentWorld = Mod.WorldShare.Store:Get('world/currentWorld')
                        local currentEnterWorld = Mod.WorldShare.Store:Get('world/currentEnterWorld')

                        if currentEnterWorld and
                           currentEnterWorld.foldername == currentWorld.foldername then
                            GameLogic.AddBBS(nil, L'不能重命名当前编辑的世界', 3000, '255 0 0')
                            return
                        end

                        if do_modify then
                            -- 客户端处理铭感词
                            local temp = MyCompany.Aries.Chat.BadWordFilter.FilterString(temp_modify_worldname);
                            if temp~=temp_modify_worldname then 
                                _guihelper.MessageBox(L"世界名包含敏感词，请重新修改");
                                return
                            end

                            local count = 0
                            for uchar in string.gfind(temp_modify_worldname, '([%z\1-\127\194-\244][\128-\191]*)') do
                                if #uchar ~= 1 then
                                    count = count + 2
                                else
                                    count = count + 1
                                end
                            end
                            
                            if count > 66 then
                                _guihelper.MessageBox(format(L'世界名字超过%d个字符, 请重新输入', 66))
                                return
                            end

                            -- update world name
                            if Create:WorldRename(
                                current_item_index,
                                temp_modify_worldname,
                                function()
                                    Create:GetWorldList(Create.statusFilter, function()
                                        switch_world(current_item_index)
                                    end)
                                end
                            ) then
                                temp_modify_worldname = ''
                            else
                                temp_modify_worldname = ''
                                do_modify = not do_modify
                                page:Refresh(0)
                            end

                            return
                        end

                        do_modify = not do_modify
                        page:Refresh(0)
                    end

                    function be_selected()
                        return Eval('index') == Create.worldIndex
                    end

                    function get_share_button(style)
                        if style == 'folder' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#392 50 38 38)';
                        end

                        if style == 'delete' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#348 50 38 38)';
                        end

                        if style == 'sync' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#437 50 38 38)';
                        end

                        if style == 'enter' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#419 10 38 38)';
                        end

                        if style == 'web' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#65 459 38 39)';
                        end

                        if style == 'revision' then
                            return 'background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#19 460 38 38)';
                        end

                        if style == 'exit' then
                            return 'background: url(Texture/Aries/Creator/paracraft/WorldShare/tuichu_40X40_32bits.png#0 0 40 40);';
                        end
                    end

                    function get_world_version()
                        return Create:GetCurWorldInfo('revision', Eval('index')) or 0
                    end

                    function get_world_version_width()
                        local version = 'v' .. tostring(get_world_version())

                        return 'width: ' .. _guihelper.GetTextWidth(version, 'System;12') .. 'px'
                    end

                    function get_world_size()
                        local size = Create:GetCurWorldInfo('size', Eval('index'))

                        if not size then
                            size = 0
                        end

                        return Mod.WorldShare.Utils.FormatFileSize(size)
                    end

                    function can_be_sync()
                        return KeepworkServiceSession:IsSignedIn() and not Create:GetCurWorldInfo('is_zip', Eval('index'))
                    end

                    function get_world_date()
                        local datetime = Create:GetCurWorldInfo('modifyTime', Eval('index'))
                        datetime = Mod.WorldShare.Utils:RecentDatetimeFormat(datetime)
                        return datetime
                    end

                    function selected_version(index)
                        local selectedWorld = Create:GetSelectWorld(index)

                        if not selectedWorld then
                            return
                        end

                        if selectedWorld and selectedWorld.status == 1 then
                            _guihelper.MessageBox(L'此世界仅在本地，无需切换版本')
                            return
                        end

                        VersionChange:Init(selectedWorld.foldername, function()
                            refresh()
                        end)
                    end

                    function go_to_url()
                        local url = Page:GetValue('content','');

                        if pid then
                            CommonLoadWorld:EnterWorldById(pid)
                        else
                            CommonLoadWorld.GotoUrl(url)
                        end
                    end

                    function refresh()
                        Create:GetWorldList(Create.statusFilter)
                    end

                    function username()
                        local userType = Mod.WorldShare.Store:Get('user/userType')
                        local isVip = Mod.WorldShare.Store:Get('user/isVip')
                        local username = Mod.WorldShare.Store:Get('user/username') or ''
                        local textWidth = _guihelper.GetTextWidth(username)

                        local styleStr = ''

                        local user_info = {}
                        local count = 0

                        if userType.teacher then
                            user_info.tLevel = 1
                            count = count + 1
                            end
                            
                        if userType.student then
                            user_info.student = 1
                            count = count + 1
                        end
                            
                        if isVip then
                            user_info.vip = 1
                            count = count + 1
                        end

                        styleStr = KpUserTag.GetMcml(user_info)

                        if not styleStr or styleStr == '' then
                            styleStr = styleStr ..  '<div style="text-align: center">' .. username .. '</div>'
                        else
                            local margin_left = 0

                            if count >= 2 then
                                count = 2
                            end

                            margin_left = (140 - textWidth - 2 - 18 * count) / 2

                            styleStr = '<div style="float: left;margin-left: ' .. margin_left .. 'px;margin-top: 2px;">' .. styleStr .. '</div>' .. '<div style="float: left;margin-left: 2px;">' .. username .. '</div>'
                        end

                        return styleStr
                    end

                    function close()
                        local function handle()
                            Create:Close()

                            if not Mod.WorldShare.Store:Get('world/isEnterWorld') then
                                if KeepworkServiceSession:IsSignedIn() then
                                    KeepworkServiceSession:Logout(nil)
                                    MainLogin:Init()
                                else
                                    MainLogin:Init()
                                end
                            end
                        end

                        if KeepworkServiceSession:GetUserWhere() == 'LOCAL' and
                           KeepworkServiceSession:IsSignedIn() and
                           not Mod.WorldShare.Store:Get('world/isEnterWorld') then
                            KeepworkServiceSession:Logout(nil, handle)
                        else
                            handle()
                        end
                    end

                    function is_list_refreshing()
                        return Create:IsRefreshing()
                    end

                    function switch_world(index)
                        do_modify = false
                        current_item_index = index
                        Create:OnSwitchWorld(index)
                    end

                    function is_signed_in()
                        return KeepworkServiceSession:IsSignedIn()
                    end

                    function delete_world(index)
                        --print("delete===============")
                        switch_world(index)
                        Create:DeleteWorld(index)
                    end

                    function sync(index)
                        Create:Sync(index)
                    end

                    function enter(index)
                        Create:EnterWorld(index)
                    end

                    function get_world_text()
                        if type(Eval('text')) ~= 'string' then
                            return ''
                        end

                        local text = Eval('text')
                        text = MyCompany.Aries.Chat.BadWordFilter.FilterString(text)
                        text = Mod.WorldShare.Utils.WordsLimit(text, 150, 25)

                        if Eval('is_zip') == true then
                            text = text .. '.zip'
                        end

                        return text
                    end

                    function open_project(index)
                        local kpProjectId = Create:GetCurWorldInfo('kpProjectId', index) or 0
                        local url = format('/pbl/project/%d/', kpProjectId)

                        Mod.WorldShare.Utils.OpenKeepworkUrlByToken(url)
                    end

                    function update_temp_modify_worldname(name, mcmlNode)
                        temp_modify_worldname = mcmlNode:GetUIValue()
                    end

                    function get_tagname()
                        if Eval('name') and Eval('name') ~= '' then
                            return Eval('name')
                        end
                    end

                    function get_world_preview()
                        local status = Eval('status')
                        local empty_preview = 'Texture/Aries/Creator/paracraft/konbaitu_266x134_x2_32bits.png# 0 0 532 268'

                        if tonumber(status) == 2 then
                            local project = Eval('project')

                            if not project or
                               type(project) ~= 'table' or
                               not project.extra or
                               type(project.extra) ~= 'table' or
                               not project.extra.imageUrl or
                               type(project.extra.imageUrl) ~= 'string' or
                               project.extra.imageUrl == '' then
                                return empty_preview
                            end

                            return project.extra.imageUrl
                        else
                            local worldpath = Eval('worldpath')

                            if not worldpath or type(worldpath) ~= 'string' then
                                return empty_preview
                            end

                            local preview = worldpath .. 'preview.jpg'

                            if ParaIO.DoesFileExist(preview) then
                                return preview
                            else
                                return empty_preview
                            end
                        end
                    end

                    function get_username()
                        local user = Eval('user')
                        local ret
                        if not user or type(user) ~= 'table' then
                            ret = '<%= "暂无" %>'
                        else 
                            if user.username then
                                ret = user.username
                            else
                                ret = '<%= "暂无" %>'
                            end
                        end
                        ret = MyCompany.Aries.Chat.BadWordFilter.FilterString(ret)
                        return ret
                    end

                    function has_username()
                        local user = Eval('user')

                        if not user or type(user) ~= 'table' or not user.username then
                            return false
                        end

                        return true
                    end

                    function get_user_icon()
                        local user = Eval('user')

                        if not user or type(user) ~= 'table' then
                            return ''
                        end

                        local user_info = {}
                        local count = 0

                        if user and user.tLevel and type(user.tLevel) == 'number' and user.tLevel >= 1 then
                            user_info.tLevel = 1
                            count = count + 1
                        end
                            
                        if user and user.student and type(user.student) == 'number' and user.student == 1 then
                            user_info.student = 1
                            count = count + 1
                        end
                            
                        if user and user.vip and type(user.vip) == 'number' and user.vip == 1 then
                            user_info.vip = 1
                            count = count + 1
                        end

                        return KpUserTag.GetMcml(user_info)
                    end

                    function get_project_views()
                        local project = Eval('project')

                        if not project or type(project) ~= 'table' then
                            return 0
                        end

                        if project.visit and type(project.visit) == 'number' then
                            return project.visit
                        else
                            return 0
                        end
                    end

                    function get_project_thumbs()
                        local project = Eval('project')

                        if not project or type(project) ~= 'table' then
                            return 0
                        end

                        if project.star and type(project.star) == 'number' then
                            return project.star
                        else
                            return 0
                        end
                    end

                    function get_project_comments()
                        local project = Eval('comment')

                        if not project or type(project) ~= 'table' then
                            return 0
                        end

                        if project.comment and type(project.comment) == 'number' then
                            return project.comment
                        else
                            return 0
                        end
                    end

                    function get_project_collect()
                        local project = Eval('project')

                        if not project or type(project) ~= 'table' then
                            return 0
                        end

                        if project.favorite and type(project.favorite) == 'number' then
                            return project.favorite
                        else
                            return 0
                        end
                    end

                    function has_rated()
                        local project = Eval('project')

                        if not project or type(project) ~= 'table' then
                            return false
                        end

                        if project.rate and type(project.rate) == 'number' and project.rate > 0 then
                            return true
                        else
                            return false
                        end
                    end

                    function get_share_world_info_button_style()
                        local count = 6

                        if not can_be_sync() then
                            count = count - 1
                        end

                        if not Eval('hasPid') then
                            count = count - 1
                        end

                        local width = count * (36 + 6)

                        return width .. 'px'
                    end

                    function open_folder(index)
                        if System.os.GetPlatform() ~= 'win32' and
                           System.os.GetPlatform() ~= 'mac' then
                            _guihelper.MessageBox(L'暂不支持当前系统打开文件夹')
                            return
                        end

                        local currentSelectedWorld = Create:GetSelectWorld(index)

                        if currentSelectedWorld and
                           type(currentSelectedWorld) == 'table' and
                           currentSelectedWorld.status and
                           currentSelectedWorld.status == 2 then
                            _guihelper.MessageBox(L'请先下载世界')
                            return
                        end

                        local worldpath = currentSelectedWorld.worldpath or ''

                        Map3DSystem.App.Commands.Call(
                            'File.WinExplorer',
                            {
                                filepath = ParaIO.GetWritablePath() .. worldpath,
                                silentmode = true
                            }
                        )
                    end

                    function set_default(name)
                        if name == 'content' then
                            page:FindControl('open_content'):SetDefault(true)
                        end

                        if name == 'search_text_online' then
                            page:FindControl('search_button_online'):SetDefault(true)
                        end

                        if name == 'search_text_offline' then
                            page:FindControl('search_button_offline'):SetDefault(true)
                        end
                    end

                    function not_encrypt_world()
                        if Eval('level') and Eval('level') == 1 then
                            return false
                        else
                            return true
                        end
                    end

                    function get_columns_style()
                        local embed_container = page:FindControl('embed_container')

                        return 'width: ' .. (embed_container.width / 4 - 5) .. 'px;'
                    end

                    function is_show_exit_button()
                        local index = Eval('index')
                        local selectedWorld = Create:GetSelectWorld(index)

                        if selectedWorld and
                           selectedWorld.status and
                           selectedWorld.shared then
                            local username = Mod.WorldShare.Store:Get('user/username')

                            if not selectedWorld.isSystemGroup and
                               username ~= selectedWorld.user.username then
                                return true
                            else
                                return false
                            end
                        else
                            return false
                        end
                    end

                    function exit_world(index)
                        local selectedWorld = Create:GetSelectWorld(index)

                        if not selectedWorld then
                            return
                        end

                        _guihelper.MessageBox(
                            format(L'确定要退出《%s》项目？<br />(注意：退出后本地数据也会删除！)', selectedWorld.text),
                            function(res)
                                if res and res == _guihelper.DialogResult.Yes then
                                    local currentWorld = Mod.WorldShare.Store:Get('world/currentWorld')

                                    if currentWorld.kpProjectId == selectedWorld.kpProjectId then
                                        KeepworkServiceProject:LeaveMultiProject(currentWorld.kpProjectId, function(data, err)
                                            if err == 200 then
                                                if currentWorld.status == 2 then
                                                    Create:GetWorldList(Create.statusFilter)
                                                else
                                                    DeleteWorld:DeleteLocal(function()
                                                        Create:GetWorldList(Create.statusFilter)
                                                    end, true)
                                                end
                                            end
                                        end)
                                    end
                                end
                            end,
                            _guihelper.MessageBoxButtons.YesNo
                        )
                    end

                    function get_selected_bg()
                        if be_selected() then
                            return 'share_selected_item_bg'
                        else
                            return 'share_unselect_item_bg'
                        end
                    end

                    function get_open_folder_tips()
                        local world_path =  Eval('worldpath') or ''

                        if System.os.GetPlatform() == 'win32' then
                            world_path = commonlib.Encoding.DefaultToUtf8(world_path)
                            world_path = world_path:gsub('/', "\\")
                        end

                        return format('%s%s', L'打开世界文件夹\n', world_path)
                    end

                    function is_show_modify_button()
                        local is_shared = Create:GetCurWorldInfo('shared', Eval('index'))

                        if is_shared then
                            local username = Mod.WorldShare.Store:Get('user/username')
                            local user = Create:GetCurWorldInfo('user', Eval('index'))

                            if not user or
                               type(user) ~= 'table' or
                               not user.username then
                                return false
                            end

                            if username == user.username then
                                return true
                            else
                                return false
                            end
                        else
                            return true
                        end
                    end

                    function has_project_id()
                        local currentSelectedWorld = Create:GetSelectWorld(Eval('index'))

                        if currentSelectedWorld and
                           type(currentSelectedWorld) == 'table' and
                           currentSelectedWorld.kpProjectId and
                           type(currentSelectedWorld.kpProjectId) == 'number' and
                           currentSelectedWorld.kpProjectId ~= 0 then
                            return true
                        else
                            return false
                        end
                    end

                    function share(index)
                        if index ~= Create.worldIndex then
                            switch_world(index)
                        end
                        local currentSelectedWorld = Create:GetSelectWorld(index)
                        
                        if currentSelectedWorld and
                           type(currentSelectedWorld) == 'table' and
                           currentSelectedWorld.kpProjectId and
                           type(currentSelectedWorld.kpProjectId) == 'number' and
                           currentSelectedWorld.kpProjectId ~= 0 then
                           ShareWorld:ShowWorldCode(currentSelectedWorld.kpProjectId,2)
                        end
                    end

                    function lazy_load()
                        Create.page = Create.page + 1

                        Create:GetPageList()
                    end

                    function is_load_more_items(index)
                        if not Create.currentWorldList or
                           type(Create.currentWorldList) ~= 'table' then
                            return
                        end

                        if index >= #Create.currentWorldList then
                            return false
                        end

                        if index == #Create.pageList then
                            return true
                        end
                    end

                    local click_previews = {}

                    function click_preview(index)
                        if index ~= Create.worldIndex then
                            switch_world(index)
                            return
                        end

                        if System.os.IsTouchMode() then
                            enter(index)
                        else
                            if not click_previews[index] then
                                click_previews[index] = {}
                            end

                            local click_preview_item = click_previews[index]
                            local click_times = click_preview_item.click_times or 1

                            if click_times >= 2 then
                                click_preview_item.click_times = 1

                                if click_preview_item.timer then
                                    click_preview_item.timer:Change(nil, nil)
                                end

                                enter(index)

                                return
                            end

                            click_preview_item.click_times = click_times + 1

                            click_preview_item.timer = commonlib.Timer:new({
                                callbackFunc = function()
                                    click_preview_item.click_times = 1
                                    click_preview_item.timer:Change(nil, nil)
                                    click_preview_item.timer = nil
                                end
                            })

                            click_preview_item.timer:Change(500, 0)
                        end
                    end
                ]]>
            </script>
            <style type='text/mcss' src='Mod/WorldShare/cellar/Theme/Mcss/Theme1.mcss'>
                {
                    share_selected_item_bg = {
                        background = 'Texture/Aries/Creator/keepwork/worldshare_32bits.png;471 212 30 30:11 11 11 11',
                        ['margin-left'] = 2.5,
                    },
                    share_unselect_item_bg = {
                        background = 'Texture/Aries/Creator/keepwork/worldshare_32bits.png;435 212 30 30:11 11 11 11',
                    },
                    share_world_name = {
                        ['text-singleline'] = 'true',
                        width = 210,
                        height = 24,
                        float = 'left',
                        ['font-size'] = 14,
                        ['base-font-size'] = 14,
                        ['margin-top'] = 3,
                        ['text-align'] = 'left',
                        color = '#323948',
                    },
                    share_button = {
                        width = 36,
                        height = 37,
                        ['margin-right'] = 6,
                    },
                    status = {
                        float = 'left',
                        width = 16,
                        height = 16,
                        ['margin-top'] = 8,
                        ['margin-bottom'] = 8,
                    },
                    list_search_bar = {
                        float = 'left',
                        ['margin-left'] = 10,
                        ['margin-top'] = 0,
                        width = 316,
                        height = 30,
                    },
                    list_search_textfield = {
                        width = 266,
                        height = 30,
                        background = ''
                    },
                    list_search_button = {
                        position = 'relative',
                        align = 'right',
                        color = '#000000',
                        height = 30,
                        width = 57,
                        ['text-align'] = 'center',
                        ['margin-top'] = -32
                    },
                    list_search_button_click = {
                        postion = 'relative',
                        height = 30,
                        width = 57
                    },
                }
            </style>
            <pe:container width='1132' height='470' name='embed_container' style='background: url();'>
                <div style='width: 1132px; height:470px;'>
                    <pe:if condition='<%= is_list_refreshing() %>'>
                        <div style='margin-left: 330px;margin-top: 140px;'>
                            <div style='margin-left: 58px;
                                        margin-bottom: 20px;
                                        width: 104px;
                                        height: 109px;
                                        background:url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#500 15 104 109);
                                        background-animation:url(script/UIAnimation/CommonProgress.lua.table#WaitingSpin)'></div>
                            <div style='width: 226px;height: 23px;background: url(Texture/Aries/Creator/keepwork/worldshare_32bits.png#447 137 226 23)'></div>
                        </div>
                    </pe:if>
                    <pe:if style='font-weight:bold;color:#ffffff' condition='<%= not is_list_refreshing() %>'>
                        <pe:gridview name='gw_world_ds' VerticalScrollBarOffsetX="20"  RememberScrollPos='true' AllowPaging='false' VerticalScrollBarStep='100' DefaultNodeHeight='200' CellPadding='10' ItemsPerLine='4'
                            onmousewheel='NPL.load("(gl)Mod/WorldShare/cellar/Create/Create.lua").OnMouseWheel()'>
                            <Columns>
                                <pe:paracraft_edit_world />
                            </Columns>
                            <EmptyDataTemplate>
                                <div style='margin: 10px;
                                            font-weight: bold;'>
                                    <div align='center'
                                        style='width: 258px;
                                                height: 244px;
                                                margin-top: 80px;
                                                background: url(Texture/Aries/Creator/paracraft/Educate/Project/kongbai_258x244_32bits.png#0 0 258 244)'>
                                        <div style="text-align: center; font-size: 14px; base-font-size: 14px; margin-top: 170px; color: #3D7EFF;" ><%=L"你还没有创建3D世界"%></div>
                                    </div>
                                </div>
                            </EmptyDataTemplate>
                            <FetchingDataTemplate>
                                <div style='margin-top:10px; font-weight:bold;'>
                                    <%=L'正在搜索, 请稍候 ... ' %>
                                </div>
                            </FetchingDataTemplate>
                            <PagerSettings Position='Bottom' />
                            <PagerTemplate AutoHidePager='true'
                                           style='margin-top: 8px;
                                                  margin-left: 80px;'>
                                <form>
                                    <input type='button'
                                           name='pre'
                                           zorder='2'
                                           class='mc_light_grey_button_with_fillet'
                                           style='float: left;
                                                  height: 20px;
                                                  font-size: 13px;'
                                           value='<%= L"上一页" %>'/>
                                    <label name='page'
                                           style='color: #ffffff;
                                                  height: 18px;
                                                  width: 50px;
                                                  text-align: center;
                                                  margin-top: -2px;'></label>
                                    <input type='button'
                                           name='next'
                                           zorder='2'
                                           class='mc_light_grey_button_with_fillet'
                                           style='float:left;
                                                  height: 20px;
                                                  font-size: 13px;'
                                           value='<%= L"下一页" %>'/>
                                </form>
                            </PagerTemplate>
                        </pe:gridview>
                    </pe:if>
                </div>
            </pe:container>
        </pe:mcml>
    </body>
</html>
